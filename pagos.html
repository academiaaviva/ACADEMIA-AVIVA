<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pagos - AVIVA</title>
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* --- ESTILOS GENERALES Y LAYOUT --- */
        .contenido-admin { max-width: 1400px; margin: 20px auto; padding: 0 20px 80px; }
        .tarjeta-gestion { background-color: #082348; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); margin-bottom: 25px; }
        
        /* --- ESTILOS DE TABLA Y RESUMEN (KPIs) --- */
        .tabla-gestion-aviva th, .tabla-gestion-aviva td { min-width: 80px; padding: 10px 15px; white-space: nowrap; }
        .tabla-gestion-aviva thead th { font-weight: 700; text-transform: uppercase; background-color: #051937; }
        .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .resumen-card { background-color: #051937; padding: 15px; border-left: 5px solid #DAA520; border-radius: 5px; }
        .resumen-card .valor { font-size: 2em; font-weight: 700; color: #FFFFFF; }
        .resumen-card .valor.red { color: #FF7043; } 
        .resumen-card .valor.green { color: #8BC34A; } 
        .resumen-card .label { color: #DAA520; font-weight: 500; }

        /* --- TOOLBARS: BÚSQUEDA Y REPORTE DE IMPRESIÓN --- */
        /* Contenedor de búsqueda en la parte superior del listado */
        .top-search-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: #051937; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 25px; 
        }

        #search-box { 
            padding: 10px; 
            border: 1px solid #DAA520; 
            border-radius: 4px; 
            background-color: #082348; 
            color: #FFFFFF; 
            flex-grow: 1; 
            max-width: 500px; 
        }
        
        .report-toolbar { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            flex-wrap: wrap;
            margin-bottom: 25px; 
        }
        .report-toolbar label { color: #E0E0E0; font-weight: 600; }
        #select-alumno-reporte { padding: 10px; border: 1px solid #DAA520; border-radius: 4px; background-color: #082348; color: #FFFFFF; min-width: 250px; }
        
        /* --- ESTILOS DEL MODAL Y FORMULARIO --- */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.7); padding-top: 60px; }
        .modal-contenido { background-color: #051937; margin: 5% auto; padding: 30px; border: 1px solid #DAA520; width: 90%; max-width: 600px; border-radius: 8px; }
        .modal-close { color: #DAA520; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .formulario-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .formulario-grid .campo-completo { grid-column: span 2; }
        .formulario-grid label { color: #E0E0E0; display: block; margin-bottom: 5px; }
        .formulario-grid input[type="text"], .formulario-grid input[type="number"], .formulario-grid input[type="date"], .formulario-grid select { 
            width: 100%; padding: 10px; border: 1px solid #DAA520; border-radius: 4px; background-color: #082348; color: #FFFFFF; box-sizing: border-box; 
        }
        
        /* --- ESTILOS ESPECÍFICOS PARA IMPRESIÓN (Media Query) --- */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 10pt;
                color: black;
            }
            #print-area table { border-collapse: collapse; width: 100%; margin-top: 20px; }
            #print-area th, #print-area td { border: 1px solid #ccc; padding: 8px; text-align: left; color: black; }
            .print-header { display: flex; align-items: center; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
            .print-header img { height: 60px; margin-right: 15px; vertical-align: middle; }
            .total-row td { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; color: black !important; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-contenido">
            <img src="https://i.ibb.co/Qv2NxLbN/fbbf9ca0-b866-4ce4-a827-443177c32603-removebg-preview.png" alt="Logo AVIVA" class="logo-header">
            <h1>Gestión de Pagos y Finanzas</h1>
            <a href="administracion.html" style="margin-left: auto; margin-right: 20px; color: #DAA520; font-size: 1.1em;" title="Volver al Panel">
                 <i class="fas fa-arrow-left"></i> Panel
            </a>
            <a href="maestros.html" style="color: #DAA520; font-size: 1.1em;" title="Cerrar Sesión">
                 <i class="fas fa-power-off"></i> Salir
            </a>
        </div>
    </header>

    <main class="contenido-admin">
        
        <div class="tarjeta-gestion">
            <h4><i class="fas fa-chart-line"></i> Resumen de Pagos del Mes</h4>
            <div class="resumen-grid">
                
                <div class="resumen-card">
                    <div class="label">Monto Recaudado</div>
                    <div class="valor green" id="total-recaudado">Cargando...</div>
                </div>

                <div class="resumen-card">
                    <div class="label">Total Transacciones</div>
                    <div class="valor" id="total-transacciones">0</div>
                </div>
                
                <div class="resumen-card">
                    <div class="label">Promedio de Pago</div>
                    <div class="valor" id="promedio-pago">Cargando...</div>
                </div>
                
                <div class="resumen-card">
                    <div class="label">Pagos Pendientes Estimados</div>
                    <div class="valor red" id="pendientes-estimados">0</div>
                </div>
                
            </div>
        </div>

        <div class="top-search-bar">
            <i class="fas fa-search" style="color: #DAA520; font-size: 1.5em;"></i>
            <input type="text" id="search-box" placeholder="Buscar en Historial (Concepto, Estudiante o ID)..." onkeyup="filtrarPagos()">
            
            <button class="boton-rol" style="width: auto;" onclick="openModal()">
                <i class="fas fa-plus-circle"></i> Registrar Nuevo Pago
            </button>
        </div>


        <div class="report-toolbar">
            <label for="select-alumno-reporte"><i class="fas fa-file-invoice"></i> Reporte Individual de Pagos:</label>
            <select id="select-alumno-reporte">
                <option value="">-- Seleccionar Alumno --</option>
            </select>
            <button class="boton-rol" style="width: auto;" onclick="imprimirReporte()" id="btn-imprimir" disabled>
                <i class="fas fa-print"></i> Imprimir Registros
            </button>
        </div>


        <div class="tarjeta-gestion">
            <h4 style="margin-top: 0;"><i class="fas fa-list-alt"></i> Historial de Transacciones (Filtrado)</h4>
            
            <div style="overflow-x: auto;">
                <table class="tabla-gestion-aviva">
                    <thead>
                        <tr>
                            <th>ID Transacción</th>
                            <th>Estudiante</th>
                            <th>ID Alumno</th>
                            <th>Concepto</th>
                            <th>Monto</th>
                            <th>Fecha</th>
                            <th>Método</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body-pagos">
                        <tr><td colspan="8" style="text-align: center;">Cargando historial de pagos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>
    
    <footer>
        <p><a href="#" class="enlace-footer">Acerca de</a> | &copy; 2025 Academia AVIVA.</p>
    </footer>


    <div id="pagoModal" class="modal-overlay">
        <div class="modal-contenido">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2><i class="fas fa-plus-circle"></i> Registrar Pago</h2>
            <form id="form-registrar-pago">
                <div class="formulario-grid">
                    <div class="campo-completo">
                        <label for="pago_estudiante_id">Estudiante</label>
                        <select id="pago_estudiante_id" required>
                            <option value="">-- Seleccionar Estudiante --</option>
                        </select>
                    </div>
                    
                    <div class="campo">
                        <label for="pago_concepto">Concepto</label>
                        <select id="pago_concepto" required onchange="manejarCamposDinamicos()">
                            <option value="Mensualidad">Mensualidad</option>
                            <option value="Matrícula">Matrícula</option>
                            <option value="Instrumento Adicional">Instrumento Adicional</option>
                            <option value="Otro">Otro (Especificar en descripción)</option>
                        </select>
                    </div>

                    <div class="campo" id="contenedor_mes">
                        <label for="pago_mes">Mes de Pago</label>
                        <select id="pago_mes" required>
                            <option value="Enero">Enero</option>
                            <option value="Febrero">Febrero</option>
                            <option value="Marzo">Marzo</option>
                            <option value="Abril">Abril</option>
                            <option value="Mayo">Mayo</option>
                            <option value="Junio">Junio</option>
                            <option value="Julio">Julio</option>
                            <option value="Agosto">Agosto</option>
                            <option value="Septiembre">Septiembre</option>
                            <option value="Octubre">Octubre</option>
                            <option value="Noviembre">Noviembre</option>
                            <option value="Diciembre">Diciembre</option>
                        </select>
                    </div>

                    <div class="campo">
                        <label for="pago_monto">Monto ($)</label>
                        <input type="number" id="pago_monto" min="1" step="0.01" required placeholder="Ej: 150.00">
                    </div>
                    <div class="campo">
                        <label for="pago_fecha">Fecha de Pago</label>
                        <input type="date" id="pago_fecha" required>
                    </div>
                    
                    <div class="campo">
                        <label for="pago_metodo">Método de Pago</label>
                        <select id="pago_metodo" required onchange="manejarCamposDinamicos()">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia Bancaria</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                    </div>

                    <div class="campo" id="contenedor_referencia" style="display: none;">
                        <label for="pago_referencia">N° de Transferencia/Referencia</label>
                        <input type="text" id="pago_referencia" placeholder="Ej: 1A2B3C4D">
                    </div>
                    
                    <div class="campo-completo">
                        <label for="pago_descripcion">Descripción (Opcional)</label>
                        <input type="text" id="pago_descripcion" placeholder="Notas adicionales o referencia">
                    </div>

                    <div class="campo-completo">
                        <button type="submit" class="boton-rol" style="margin-top: 10px;">
                            <i class="fas fa-receipt"></i> Registrar Transacción
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="print-area" style="display: none;"></div>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // *** 1. TUS CLAVES DE CONFIGURACIÓN DE FIREBASE ***
        const firebaseConfig = {
          apiKey: "AIzaSyC1siR7mrHnOTXozBk6lZ22ZxU352ve4lI",
          authDomain: "academia-aviva.firebaseapp.com",
          projectId: "academia-aviva",
          storageBucket: "academia-aviva.firebasestorage.app",
          messagingSenderId: "1083662705160",
          appId: "1:1083662705160:web:31252ae5d15e994823a7bd",
          measurementId: "G-GNBRN8CF2T"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const pagosCollection = db.collection('pagos'); 
        const estudiantesCollection = db.collection('estudiantes'); 

        const tablaBodyPagos = document.getElementById('tabla-body-pagos');
        const pagoModal = document.getElementById('pagoModal');
        const selectEstudiantesPago = document.getElementById('pago_estudiante_id');
        const selectReporte = document.getElementById('select-alumno-reporte');
        const btnImprimir = document.getElementById('btn-imprimir');
        const searchBox = document.getElementById('search-box');
        
        let estudiantesCache = {}; 
        let allPagosData = []; 
        const hoy = new Date().toISOString().split('T')[0];
        const LOGO_URL = "https://i.ibb.co/Qv2NxLbN/fbbf9ca0-b866-4ce4-a827-443177c32603-removebg-preview.png"; 

        // Referencias a campos dinámicos
        const contenedorMes = document.getElementById('contenedor_mes');
        const selectMes = document.getElementById('pago_mes');
        const selectConcepto = document.getElementById('pago_concepto');
        
        const contenedorReferencia = document.getElementById('contenedor_referencia');
        const inputReferencia = document.getElementById('pago_referencia');
        const selectMetodo = document.getElementById('pago_metodo');

        // ==================================================
        // 2. INICIALIZACIÓN Y LÓGICA DINÁMICA
        // ==================================================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('pago_fecha').value = hoy; 
            cargarEstudiantesParaSelect(); // Inicia la carga de estudiantes
            
            selectReporte.addEventListener('change', () => {
                btnImprimir.disabled = !selectReporte.value;
            });
            
            manejarCamposDinamicos();
        });
        
        // Listener para los pagos (SE INICIA AL FINAL DE cargarEstudiantesParaSelect)
        function iniciarPagosListener() {
            pagosCollection.orderBy('fecha', 'desc').onSnapshot(snapshot => {
                allPagosData = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
                
                actualizarResumen(allPagosData);
                filtrarPagos(); 
            }, error => {
                console.error("Error al escuchar cambios en Firestore (Pagos):", error);
                tablaBodyPagos.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #FF7043;">Error de conexión a la base de datos.</td></tr>`;
            });
        }
        
        function cargarEstudiantesParaSelect() {
            selectEstudiantesPago.innerHTML = '<option value="">Cargando estudiantes...</option>';
            selectReporte.innerHTML = '<option value="">Cargando alumnos...</option>';
            
            estudiantesCollection.orderBy('apellido', 'asc').get()
                .then(snapshot => {
                    selectEstudiantesPago.innerHTML = '<option value="">-- Seleccionar Estudiante --</option>';
                    selectReporte.innerHTML = '<option value="">-- Seleccionar Alumno --</option>';
                    estudiantesCache = {};
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const nombreCompleto = `${data.apellido || ''}, ${data.nombre || ''} (${data.id_estudiante || 'ID N/A'})`;
                        
                        estudiantesCache[doc.id] = { 
                            nombre: `${data.nombre} ${data.apellido}`, 
                            id_estudiante: data.id_estudiante 
                        };

                        let option = document.createElement('option');
                        option.value = doc.id; 
                        option.textContent = nombreCompleto;
                        selectEstudiantesPago.appendChild(option.cloneNode(true));
                        selectReporte.appendChild(option);
                    });
                    
                    // === PUNTO DE CORRECCIÓN CLAVE ===
                    // UNA VEZ QUE EL CACHÉ DE ESTUDIANTES ESTÁ LLENO, INICIAMOS EL LISTENER DE PAGOS
                    iniciarPagosListener(); 

                })
                .catch(error => {
                    console.error("Error al cargar estudiantes:", error);
                    // Si falla la carga de estudiantes, mostramos un error en la tabla de pagos
                    tablaBodyPagos.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #FF7043;">Error al cargar datos de estudiantes.</td></tr>`;
                });
        }
        
        function manejarCamposDinamicos() {
            // 1. Lógica para el Mes (Depende del Concepto)
            const esMensualidad = selectConcepto.value === 'Mensualidad';
            
            // Reemplazamos 'block' por 'inline-block' para mantener el formato de dos columnas si es posible
            contenedorMes.style.display = esMensualidad ? 'block' : 'none'; 
            selectMes.required = esMensualidad;
            
            if (!esMensualidad) {
                selectMes.value = ""; 
            }

            // 2. Lógica para la Referencia (Depende del Método)
            const esTransferencia = selectMetodo.value === 'Transferencia';

            contenedorReferencia.style.display = esTransferencia ? 'block' : 'none';
            inputReferencia.required = esTransferencia;

            if (!esTransferencia) {
                inputReferencia.value = "";
            }
        }


        // ==================================================
        // 3. LÓGICA DE FIREBASE (Lectura y Filtro)
        // ==================================================

        // *Se movió la inicialización de este listener a iniciarPagosListener()*

        // Actualiza las tarjetas de resumen
        function actualizarResumen(pagos) {
            let totalRecaudado = 0;
            let totalTransacciones = pagos.length;

            pagos.forEach(pago => {
                totalRecaudado += Number(pago.monto);
            });

            const promedioPago = totalTransacciones > 0 ? (totalRecaudado / totalTransacciones) : 0;
            const formatter = new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'USD' });

            document.getElementById('total-recaudado').textContent = formatter.format(totalRecaudado);
            document.getElementById('total-transacciones').textContent = totalTransacciones;
            document.getElementById('promedio-pago').textContent = formatter.format(promedioPago);
            document.getElementById('pendientes-estimados').textContent = 'N/A';
        }

        // Renderiza la tabla de transacciones
        function renderizarTabla(pagosArray) {
            tablaBodyPagos.innerHTML = '';
            
            if (pagosArray.length === 0) {
                tablaBodyPagos.innerHTML = `<tr><td colspan="8" style="text-align: center;">No se encontraron transacciones.</td></tr>`;
                return;
            }

            pagosArray.forEach(pago => {
                // Aquí ya estamos seguros de que estudiantesCache está lleno.
                const infoEstudiante = estudiantesCache[pago.estudianteId] || { 
                    nombre: 'ID NO VINCULADO', 
                    id_estudiante: 'N/A' 
                }; 
                
                const fila = tablaBodyPagos.insertRow();
                const montoFormateado = new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'USD' }).format(pago.monto);
                
                let conceptoMostrar = pago.concepto || 'N/A';
                if (pago.mes) {
                    conceptoMostrar += ` (${pago.mes})`;
                }
                
                let metodoMostrar = pago.metodo || 'N/A';
                if (pago.referencia) {
                    metodoMostrar += ` (Ref: ${pago.referencia})`;
                }

                fila.insertCell(0).textContent = pago.firebaseId.substring(0, 6); 
                fila.insertCell(1).textContent = infoEstudiante.nombre;
                fila.insertCell(2).textContent = infoEstudiante.id_estudiante;
                fila.insertCell(3).textContent = conceptoMostrar; 
                fila.insertCell(4).textContent = montoFormateado;
                fila.insertCell(5).textContent = pago.fecha || 'N/A';
                fila.insertCell(6).textContent = metodoMostrar; 
                
                const accionesCell = fila.insertCell(7);
                accionesCell.innerHTML = `<button class="action-btn delete-btn" data-id="${pago.firebaseId}" onclick="eliminarPago(this)"><i class="fas fa-trash"></i></button>`;
            });
        }
        
        // Función de filtrado/búsqueda
        function filtrarPagos() {
            const searchTerm = searchBox.value.toLowerCase();
            
            if (searchTerm.length === 0) {
                renderizarTabla(allPagosData);
                return;
            }

            const resultados = allPagosData.filter(pago => {
                const infoEstudiante = estudiantesCache[pago.estudianteId] || {};

                const concepto = (pago.concepto || '').toLowerCase();
                const metodo = (pago.metodo || '').toLowerCase();
                const nombreEstudiante = (infoEstudiante.nombre || '').toLowerCase();
                const idEstudiante = (infoEstudiante.id_estudiante || '').toLowerCase();
                const idTransaccion = (pago.firebaseId || '').substring(0, 6).toLowerCase();
                const mes = (pago.mes || '').toLowerCase(); 
                const referencia = (pago.referencia || '').toLowerCase(); 

                return concepto.includes(searchTerm) || 
                       metodo.includes(searchTerm) ||
                       nombreEstudiante.includes(searchTerm) || 
                       idEstudiante.includes(searchTerm) ||
                       idTransaccion.includes(searchTerm) ||
                       mes.includes(searchTerm) ||
                       referencia.includes(searchTerm);
            });

            renderizarTabla(resultados);
        }

        // ==================================================
        // 4. GENERACIÓN DEL REPORTE DE IMPRESIÓN 
        // ==================================================

        function imprimirReporte() {
            const estudianteId = selectReporte.value;
            if (!estudianteId) {
                alert("Por favor, selecciona un alumno para imprimir su historial completo.");
                return;
            }
            
            const infoEstudiante = estudiantesCache[estudianteId];
            const pagosAlumno = allPagosData.filter(pago => pago.estudianteId === estudianteId);
            
            if (pagosAlumno.length === 0) {
                alert(`El alumno ${infoEstudiante.nombre} no tiene pagos registrados.`);
                return;
            }

            const formatter = new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'USD' });
            let totalPagado = 0;

            // 1. Crear el contenido del reporte
            let tablaHTML = `
                <style>
                    /* Estilos internos para asegurar la impresión */
                    .print-header { display: flex; align-items: center; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px; color: black; }
                    .print-header img { height: 60px; margin-right: 15px; vertical-align: middle; }
                    .print-header h1 { margin: 0; font-size: 18pt; color: black; }
                    .info-alumno p { margin: 5px 0; color: black; }
                    .reporte-tabla { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    .reporte-tabla th, .reporte-tabla td { border: 1px solid #ccc; padding: 8px; text-align: left; color: black; }
                    .reporte-tabla th { background-color: #f0f0f0; }
                    .total-row td { font-weight: bold; background-color: #DAA520; color: black; } 
                </style>
                <div class="print-header">
                    <img src="${LOGO_URL}" alt="Logo Academia AVIVA">
                    <h1>Academia AVIVA - Historial de Pagos</h1>
                </div>
                <div class="info-alumno">
                    <h2>Reporte de Pagos</h2>
                    <p><strong>Alumno:</strong> ${infoEstudiante.nombre}</p>
                    <p><strong>ID Académico:</strong> ${infoEstudiante.id_estudiante}</p>
                    <p><strong>Fecha de Reporte:</strong> ${new Date().toLocaleDateString('es-NI')}</p>
                </div>
                <table class="reporte-tabla">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Concepto</th>
                            <th>Monto</th>
                            <th>Método</th>
                            <th>Descripción</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pagosAlumno.forEach(pago => {
                totalPagado += Number(pago.monto);
                
                let conceptoReporte = pago.concepto || 'N/A';
                if (pago.mes) {
                    conceptoReporte += ` (Mes: ${pago.mes})`;
                }

                let metodoReporte = pago.metodo || 'N/A';
                if (pago.referencia) {
                    metodoReporte += ` (Ref: ${pago.referencia})`;
                }

                tablaHTML += `
                    <tr>
                        <td>${pago.fecha}</td>
                        <td>${conceptoReporte}</td>
                        <td>${formatter.format(pago.monto)}</td>
                        <td>${metodoReporte}</td>
                        <td>${pago.descripcion || '---'}</td>
                    </tr>
                `;
            });

            tablaHTML += `
                    <tr class="total-row">
                        <td colspan="2">TOTAL PAGADO</td>
                        <td>${formatter.format(totalPagado)}</td>
                        <td colspan="2"></td>
                    </tr>
                    </tbody>
                </table>
                <p style="margin-top: 30px; font-style: italic; color: black;">Reporte generado automáticamente por el Sistema de Gestión AVIVA.</p>
            `;

            // 2. Insertar y mandar a imprimir
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = tablaHTML;
            
            setTimeout(() => {
                window.print();
            }, 50);
        }

        // ==================================================
        // 5. GESTIÓN DEL MODAL Y EVENTOS (CRUD)
        // ==================================================

        function openModal() { 
            pagoModal.style.display = "block"; 
            manejarCamposDinamicos(); 
        }

        function closeModal() {
            pagoModal.style.display = "none";
            document.getElementById('form-registrar-pago').reset();
            document.getElementById('pago_fecha').value = hoy; 
            manejarCamposDinamicos(); 
        }

        window.onclick = function(event) {
            if (event.target == pagoModal) {
                closeModal();
            }
        }

        document.getElementById('form-registrar-pago').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const mes = selectConcepto.value === 'Mensualidad' ? selectMes.value : null;
            const referencia = selectMetodo.value === 'Transferencia' ? inputReferencia.value : null;

            const nuevoPago = {
                estudianteId: document.getElementById('pago_estudiante_id').value,
                monto: Number(document.getElementById('pago_monto').value),
                fecha: document.getElementById('pago_fecha').value,
                concepto: document.getElementById('pago_concepto').value,
                mes: mes, 
                metodo: document.getElementById('pago_metodo').value,
                referencia: referencia, 
                descripcion: document.getElementById('pago_descripcion').value || '',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            const boton = this.querySelector('.boton-rol');
            boton.disabled = true;
            boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';

            pagosCollection.add(nuevoPago)
                .then(() => {
                    closeModal();
                })
                .catch((error) => {
                    console.error("Error al registrar el pago:", error);
                    alert("Error al registrar: " + error.message);
                })
                .finally(() => {
                    boton.disabled = false;
                    boton.innerHTML = '<i class="fas fa-receipt"></i> Registrar Transacción';
                });
        });

        function eliminarPago(boton) {
            const docId = boton.getAttribute('data-id');
            if (confirm(`¿Estás seguro de que deseas eliminar esta transacción?`)) {
                boton.disabled = true;
                pagosCollection.doc(docId).delete()
                    .then(() => {
                        // onSnapshot recarga automáticamente
                    })
                    .catch((error) => {
                        console.error("Error al eliminar la transacción:", error);
                        alert("Error al eliminar: " + error.message);
                        boton.disabled = false;
                    });
            }
        }
    </script>

</body>
</html>
