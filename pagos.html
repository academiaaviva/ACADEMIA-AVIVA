<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pagos - AVIVA</title>
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* --- ESTILOS GENERALES Y LAYOUT --- */
        .contenido-admin { max-width: 1400px; margin: 20px auto; padding: 0 20px 80px; }
        .tarjeta-gestion { background-color: #082348; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); margin-bottom: 25px; }
        .action-btn { background-color: transparent; border: none; color: #DAA520; cursor: pointer; margin: 0 5px; font-size: 1.1em; transition: color 0.2s; }
        .action-btn:hover { color: #ffd740; }
        
        /* --- TABLA DE TRANSACCIONES (Excel Style) --- */
        .tabla-gestion-aviva th, .tabla-gestion-aviva td { min-width: 80px; padding: 10px 15px; white-space: nowrap; }
        .tabla-gestion-aviva thead th { font-weight: 700; text-transform: uppercase; background-color: #051937; }

        /* --- CUADRO RESUMEN FINANCIERO (KPIs) --- */
        .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .resumen-card { 
            background-color: #051937; 
            padding: 15px; 
            border-left: 5px solid #DAA520; 
            border-radius: 5px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .resumen-card .valor { font-size: 2em; font-weight: 700; color: #FFFFFF; }
        .resumen-card .valor.red { color: #FF7043; } /* Color para montos negativos o pendientes */
        .resumen-card .valor.green { color: #8BC34A; } /* Color para montos positivos */
        .resumen-card .label { color: #DAA520; font-weight: 500; }

        /* --- ESTILOS DEL MODAL Y FORMULARIO (Adaptados) --- */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.7); padding-top: 60px; }
        .modal-contenido { background-color: #051937; margin: 5% auto; padding: 30px; border: 1px solid #DAA520; width: 90%; max-width: 600px; border-radius: 8px; }
        .modal-close { color: #DAA520; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .formulario-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .formulario-grid .campo-completo { grid-column: span 2; }
        .formulario-grid label { color: #E0E0E0; display: block; margin-bottom: 5px; }
        .formulario-grid input[type="text"], .formulario-grid input[type="number"], .formulario-grid input[type="date"], .formulario-grid select { 
            width: 100%; padding: 10px; border: 1px solid #DAA520; border-radius: 4px; background-color: #082348; color: #FFFFFF; box-sizing: border-box; 
        }
    </style>
</head>
<body>

    <header>
        <div class="header-contenido">
            <img src="https://i.ibb.co/Qv2NxLbN/fbbf9ca0-b866-4ce4-a827-443177c32603-removebg-preview.png" alt="Logo AVIVA" class="logo-header">
            <h1>Gestión de Pagos y Finanzas</h1>
            <a href="administracion.html" style="margin-left: auto; margin-right: 20px; color: #DAA520; font-size: 1.1em;" title="Volver al Panel">
                 <i class="fas fa-arrow-left"></i> Panel
            </a>
            <a href="maestros.html" style="color: #DAA520; font-size: 1.1em;" title="Cerrar Sesión">
                 <i class="fas fa-power-off"></i> Salir
            </a>
        </div>
    </header>

    <main class="contenido-admin">
        
        <div class="tarjeta-gestion">
            <h4><i class="fas fa-chart-line"></i> Resumen de Pagos del Mes</h4>
            <div class="resumen-grid">
                
                <div class="resumen-card">
                    <div class="label">Monto Recaudado</div>
                    <div class="valor green" id="total-recaudado">Cargando...</div>
                </div>

                <div class="resumen-card">
                    <div class="label">Total Transacciones</div>
                    <div class="valor" id="total-transacciones">0</div>
                </div>
                
                <div class="resumen-card">
                    <div class="label">Promedio de Pago</div>
                    <div class="valor" id="promedio-pago">Cargando...</div>
                </div>
                
                <div class="resumen-card">
                    <div class="label">Pagos Pendientes Estimados</div>
                    <div class="valor red" id="pendientes-estimados">0</div>
                </div>
                
            </div>
        </div>


        <div class="tarjeta-gestion">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h4><i class="fas fa-list-alt"></i> Historial de Transacciones</h4>
                <button class="boton-rol" style="width: auto;" onclick="openModal()">
                    <i class="fas fa-plus-circle"></i> Registrar Nuevo Pago
                </button>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="tabla-gestion-aviva">
                    <thead>
                        <tr>
                            <th>ID Transacción</th>
                            <th>Estudiante</th>
                            <th>ID Alumno</th>
                            <th>Concepto</th>
                            <th>Monto</th>
                            <th>Fecha</th>
                            <th>Método</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body-pagos">
                        <tr><td colspan="8" style="text-align: center;">Cargando historial de pagos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>
    
    <footer>
        <p><a href="#" class="enlace-footer">Acerca de</a> | &copy; 2025 Academia AVIVA.</p>
    </footer>


    <div id="pagoModal" class="modal-overlay">
        <div class="modal-contenido">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2><i class="fas fa-plus-circle"></i> Registrar Pago</h2>

            <form id="form-registrar-pago">
                <div class="formulario-grid">
                    
                    <div class="campo-completo">
                        <label for="pago_estudiante_id">Estudiante</label>
                        <select id="pago_estudiante_id" required>
                            <option value="">-- Seleccionar Estudiante --</option>
                        </select>
                    </div>

                    <div class="campo">
                        <label for="pago_monto">Monto ($)</label>
                        <input type="number" id="pago_monto" min="1" step="0.01" required placeholder="Ej: 150.00">
                    </div>
                    <div class="campo">
                        <label for="pago_fecha">Fecha de Pago</label>
                        <input type="date" id="pago_fecha" required>
                    </div>
                    
                    <div class="campo">
                        <label for="pago_concepto">Concepto</label>
                        <select id="pago_concepto" required>
                            <option value="Mensualidad">Mensualidad</option>
                            <option value="Matrícula">Matrícula</option>
                            <option value="Instrumento Adicional">Instrumento Adicional</option>
                            <option value="Otro">Otro (Especificar en descripción)</option>
                        </select>
                    </div>
                    <div class="campo">
                        <label for="pago_metodo">Método de Pago</label>
                        <select id="pago_metodo" required>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia Bancaria</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                    </div>

                    <div class="campo-completo">
                        <label for="pago_descripcion">Descripción (Opcional)</label>
                        <input type="text" id="pago_descripcion" placeholder="Notas adicionales o referencia">
                    </div>


                    <div class="campo-completo">
                        <button type="submit" class="boton-rol" style="margin-top: 10px;">
                            <i class="fas fa-receipt"></i> Registrar Transacción
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // *** 1. TUS CLAVES DE CONFIGURACIÓN DE FIREBASE ***
        const firebaseConfig = {
          apiKey: "AIzaSyC1siR7mrHnOTXozBk6lZ22ZxU352ve4lI",
          authDomain: "academia-aviva.firebaseapp.com",
          projectId: "academia-aviva",
          storageBucket: "academia-aviva.firebasestorage.app",
          messagingSenderId: "1083662705160",
          appId: "1:1083662705160:web:31252ae5d15e994823a7bd",
          measurementId: "G-GNBRN8CF2T"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Colecciones de Firebase
        const pagosCollection = db.collection('pagos'); // Nueva colección para pagos
        const estudiantesCollection = db.collection('estudiantes'); 

        // Referencias de la interfaz
        const tablaBodyPagos = document.getElementById('tabla-body-pagos');
        const pagoModal = document.getElementById('pagoModal');
        const selectEstudiantesPago = document.getElementById('pago_estudiante_id');
        
        let estudiantesCache = {}; // Para buscar el nombre del estudiante rápidamente
        const hoy = new Date().toISOString().split('T')[0];


        // ==================================================
        // 2. INICIALIZACIÓN Y CARGA DE ESTUDIANTES
        // ==================================================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('pago_fecha').value = hoy; // Pone la fecha de hoy por defecto
            cargarEstudiantesParaSelect();
        });
        
        // Carga los estudiantes en el <select> del formulario de pago
        function cargarEstudiantesParaSelect() {
            selectEstudiantesPago.innerHTML = '<option value="">Cargando estudiantes...</option>';
            estudiantesCollection.orderBy('apellido', 'asc').get()
                .then(snapshot => {
                    selectEstudiantesPago.innerHTML = '<option value="">-- Seleccionar Estudiante --</option>';
                    estudiantesCache = {};
                    if (snapshot.empty) {
                        selectEstudiantesPago.innerHTML += '<option value="" disabled>No hay estudiantes registrados.</option>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const nombreCompleto = `${data.apellido || ''}, ${data.nombre || ''} (${data.id_estudiante || 'ID N/A'})`;
                        
                        // Guardar en cache para usar en la tabla
                        estudiantesCache[doc.id] = { 
                            nombre: `${data.nombre} ${data.apellido}`, 
                            id_estudiante: data.id_estudiante 
                        };

                        const option = document.createElement('option');
                        option.value = doc.id; // ID de Firebase del estudiante
                        option.textContent = nombreCompleto;
                        selectEstudiantesPago.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Error al cargar estudiantes para el select:", error);
                    selectEstudiantesPago.innerHTML = '<option value="" disabled>Error de carga.</option>';
                });
        }


        // ==================================================
        // 3. LÓGICA DE FIREBASE (CRUD y Resumen)
        // ==================================================

        // Escucha en tiempo real para la colección de pagos
        pagosCollection.orderBy('fecha', 'desc').onSnapshot(snapshot => {
            const allPagos = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
            
            actualizarResumen(allPagos);
            renderizarTabla(allPagos);
        }, error => {
            console.error("Error al escuchar cambios en Firestore (Pagos):", error);
            tablaBodyPagos.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #FF7043;">Error de conexión a la base de datos.</td></tr>`;
        });

        // Actualiza las tarjetas de resumen
        function actualizarResumen(pagos) {
            let totalRecaudado = 0;
            let totalTransacciones = pagos.length;

            pagos.forEach(pago => {
                totalRecaudado += Number(pago.monto);
            });

            const promedioPago = totalTransacciones > 0 ? (totalRecaudado / totalTransacciones) : 0;
            
            // Formateo a moneda (ajusta 'es-NI' o 'en-US' según tu moneda local)
            const formatter = new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'USD' });

            document.getElementById('total-recaudado').textContent = formatter.format(totalRecaudado);
            document.getElementById('total-transacciones').textContent = totalTransacciones;
            document.getElementById('promedio-pago').textContent = formatter.format(promedioPago);
            
            // La estimación de pendientes requiere más lógica (clases, mensualidades), 
            // por ahora la dejamos en 0.
            document.getElementById('pendientes-estimados').textContent = 'N/A';
        }

        // Renderiza la tabla de transacciones
        function renderizarTabla(pagosArray) {
            tablaBodyPagos.innerHTML = '';
            
            if (pagosArray.length === 0) {
                tablaBodyPagos.innerHTML = `<tr><td colspan="8" style="text-align: center;">No hay transacciones registradas.</td></tr>`;
                return;
            }

            pagosArray.forEach(pago => {
                const fila = tablaBodyPagos.insertRow();
                
                // Intentar obtener el nombre/ID del estudiante de la caché
                const infoEstudiante = estudiantesCache[pago.estudianteId] || { nombre: 'Estudiante Eliminado', id_estudiante: 'N/A' };
                
                // Formateo del monto
                const montoFormateado = new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'USD' }).format(pago.monto);

                fila.insertCell(0).textContent = pago.firebaseId.substring(0, 6); // ID corto de Firebase
                fila.insertCell(1).textContent = infoEstudiante.nombre;
                fila.insertCell(2).textContent = infoEstudiante.id_estudiante;
                fila.insertCell(3).textContent = pago.concepto || 'N/A';
                fila.insertCell(4).textContent = montoFormateado;
                fila.insertCell(5).textContent = pago.fecha || 'N/A';
                fila.insertCell(6).textContent = pago.metodo || 'N/A';
                
                const accionesCell = fila.insertCell(7);
                accionesCell.innerHTML = `<button class="action-btn delete-btn" data-id="${pago.firebaseId}" onclick="eliminarPago(this)"><i class="fas fa-trash"></i></button>`;
            });
        }


        // ==================================================
        // 4. GESTIÓN DEL MODAL Y EVENTOS
        // ==================================================

        function openModal() { pagoModal.style.display = "block"; }

        function closeModal() {
            pagoModal.style.display = "none";
            document.getElementById('form-registrar-pago').reset();
            document.getElementById('pago_fecha').value = hoy; // Resetear fecha a hoy
        }

        window.onclick = function(event) {
            if (event.target == pagoModal) {
                closeModal();
            }
        }

        // Guardar la transacción en Firebase
        document.getElementById('form-registrar-pago').addEventListener('submit', function(event) {
            event.preventDefault();

            const nuevoPago = {
                estudianteId: document.getElementById('pago_estudiante_id').value,
                monto: Number(document.getElementById('pago_monto').value),
                fecha: document.getElementById('pago_fecha').value,
                concepto: document.getElementById('pago_concepto').value,
                metodo: document.getElementById('pago_metodo').value,
                descripcion: document.getElementById('pago_descripcion').value || '',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            const boton = this.querySelector('.boton-rol');
            boton.disabled = true;
            boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';

            pagosCollection.add(nuevoPago)
                .then(() => {
                    closeModal();
                    console.log("Pago registrado con éxito.");
                })
                .catch((error) => {
                    console.error("Error al registrar el pago:", error);
                    alert("Error al registrar: " + error.message);
                })
                .finally(() => {
                    boton.disabled = false;
                    boton.innerHTML = '<i class="fas fa-receipt"></i> Registrar Transacción';
                });
        });

        // Eliminar pago
        function eliminarPago(boton) {
            const docId = boton.getAttribute('data-id');
            if (confirm(`¿Estás seguro de que deseas eliminar esta transacción?`)) {
                boton.disabled = true;
                pagosCollection.doc(docId).delete()
                    .then(() => {
                        console.log(`Transacción ${docId} eliminada.`);
                        // onSnapshot se encarga de la recarga
                    })
                    .catch((error) => {
                        console.error("Error al eliminar la transacción:", error);
                        alert("Error al eliminar: " + error.message);
                        boton.disabled = false;
                    });
            }
        }
    </script>

</body>
</html>
