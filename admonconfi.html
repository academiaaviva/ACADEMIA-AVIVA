<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Acceso - AVIVA</title>
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* --- ESTILOS GENERALES Y LAYOUT --- */
        .contenido-admin { max-width: 1200px; margin: 20px auto; padding: 0 20px 80px; }
        .tarjeta-gestion { 
            background-color: #082348; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); 
            margin-bottom: 25px; 
        }
        
        /* --- LAYOUT DE DOS COLUMNAS --- */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            align-items: flex-start; /* Alinea el contenido al inicio */
        }
        
        /* --- ESTILOS DE FORMULARIO --- */
        #form-crear-acceso label { 
            color: #E0E0E0; 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500;
        }
        #form-crear-acceso input[type="text"], 
        #form-crear-acceso input[type="password"], 
        #form-crear-acceso select { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 15px; 
            border: 1px solid #DAA520; 
            border-radius: 4px; 
            background-color: #051937; 
            color: #FFFFFF; 
            box-sizing: border-box; 
        }
        
        /* --- ESTILOS DE TABLA --- */
        .tabla-gestion-aviva { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .tabla-gestion-aviva th, .tabla-gestion-aviva td { 
            padding: 12px 15px; 
            text-align: left;
        }
        .tabla-gestion-aviva thead th { 
            font-weight: 700; 
            text-transform: uppercase; 
            background-color: #051937; 
        }
        .tabla-gestion-aviva tbody tr:nth-child(even) {
            background-color: #061e3d; /* Ligeramente más claro para filas pares */
        }
        
        /* Estilos específicos de la tabla de accesos */
        .tag-rol {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9em;
            display: inline-block;
        }
        .tag-alumno { background-color: #8BC34A; color: #051937; }
        .tag-profesor { background-color: #DAA520; color: #051937; }
        .tag-director { background-color: #FF7043; color: #051937; } 

    </style>
</head>
<body>

    <header>
        <div class="header-contenido">
            <img src="https://i.ibb.co/Qv2NxLbN/fbbf9ca0-b866-4ce4-a827-443177c32603-removebg-preview.png" alt="Logo AVIVA" class="logo-header">
            <h1>Módulo de Configuración de Acceso</h1>
            <a href="administracion.html" style="margin-left: auto; margin-right: 20px; color: #DAA520; font-size: 1.1em;" title="Volver al Panel">
                 <i class="fas fa-arrow-left"></i> Panel
            </a>
            <a href="maestros.html" style="color: #DAA520; font-size: 1.1em;" title="Cerrar Sesión">
                 <i class="fas fa-power-off"></i> Salir
            </a>
        </div>
    </header>

    <main class="contenido-admin">
        
        <div class="config-grid">
            
            <div class="tarjeta-gestion">
                <h4><i class="fas fa-user-plus"></i> Crear Nuevo Acceso Limitado</h4>
                <form id="form-crear-acceso">
                    
                    <label for="nombre_usuario">Nombre o Identificador (Ej: ID Alumno)</label>
                    <input type="text" id="nombre_usuario" required placeholder="Nombre o ID único (será el usuario)">
                    
                    <label for="password">Contraseña Temporal</label>
                    <input type="password" id="password" required placeholder="Contraseña de al menos 6 caracteres">
                    
                    <label for="rol_acceso">Rol de Acceso</label>
                    <select id="rol_acceso" required>
                        <option value="">-- Seleccione Rol --</option>
                        <option value="alumno">Alumno (Acceso a estudiantes.html)</option>
                        <option value="profesor">Profesor (Acceso a maestros.html)</option>
                    </select>

                    <button type="submit" class="boton-rol" style="width: 100%;">
                        <i class="fas fa-save"></i> Registrar Credencial
                    </button>
                    
                    <p style="font-size: 0.8em; color: #DAA520; margin-top: 15px;">*Solo el Director puede crear y eliminar accesos.</p>
                </form>
            </div>

            <div class="tarjeta-gestion">
                <h4><i class="fas fa-lock"></i> Usuarios con Acceso Limitado</h4>
                
                <div style="overflow-x: auto;">
                    <table class="tabla-gestion-aviva">
                        <thead>
                            <tr>
                                <th>Usuario (ID/Nombre)</th>
                                <th>Rol</th>
                                <th>Acceso URL</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body-accesos">
                            <tr>
                                <td>DirectorAVIVA</td>
                                <td><span class="tag-rol tag-director">DIRECTOR</span></td>
                                <td>administracion.html</td>
                                <td><i class="fas fa-ban" title="No se puede eliminar el acceso principal"></i></td>
                            </tr>
                            <tr><td colspan="4" style="text-align: center;">Cargando usuarios...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

    </main>
    
    <footer>
        <p><a href="#" class="enlace-footer">Acerca de</a> | &copy; 2025 Academia AVIVA.</p>
    </footer>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-md5/0.7.3/md5.min.js"></script> 

    <script>
        // *** 1. TUS CLAVES DE CONFIGURACIÓN DE FIREBASE ***
        const firebaseConfig = {
          apiKey: "AIzaSyC1siR7mrHnOTXozBk6lZ22ZxU352ve4lI",
          authDomain: "academia-aviva.firebaseapp.com",
          projectId: "academia-aviva",
          storageBucket: "academia-aviva.firebasestorage.app",
          messagingSenderId: "1083662705160",
          appId: "1:1083662705160:web:31252ae5d15e994823a7bd",
          measurementId: "G-GNBRN8CF2T"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Nueva colección para almacenar usuarios con acceso limitado
        const usuariosAccesoCollection = db.collection('usuariosAcceso'); 

        const tablaBodyAccesos = document.getElementById('tabla-body-accesos');
        const formCrearAcceso = document.getElementById('form-crear-acceso');

        // ==================================================
        // 2. LÓGICA DE GESTIÓN DE USUARIOS
        // ==================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            iniciarListenerUsuarios();
        });

        function iniciarListenerUsuarios() {
            // Escucha cambios en tiempo real en la colección de usuariosAcceso
            usuariosAccesoCollection.orderBy('rol', 'asc').onSnapshot(snapshot => {
                renderizarTablaUsuarios(snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() })));
            }, error => {
                console.error("Error al escuchar usuarios de acceso:", error);
                tablaBodyAccesos.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #FF7043;">Error de conexión a la base de datos.</td></tr>`;
            });
        }
        
        function renderizarTablaUsuarios(usuarios) {
            // Mantener la fila del Director y limpiar el resto
            const directorRow = tablaBodyAccesos.querySelector('tr');
            tablaBodyAccesos.innerHTML = '';
            tablaBodyAccesos.appendChild(directorRow);
            
            if (usuarios.length === 0) {
                const fila = tablaBodyAccesos.insertRow();
                fila.innerHTML = `<td colspan="4" style="text-align: center;">No hay usuarios limitados registrados.</td>`;
                return;
            }

            usuarios.forEach(usuario => {
                const fila = tablaBodyAccesos.insertRow();
                
                let rolTagClass = '';
                let accesoURL = '';
                let rolDisplay = '';

                if (usuario.rol === 'alumno') {
                    rolTagClass = 'tag-alumno';
                    accesoURL = 'estudiantes.html';
                    rolDisplay = 'ALUMNO';
                } else if (usuario.rol === 'profesor') {
                    rolTagClass = 'tag-profesor';
                    accesoURL = 'maestros.html';
                    rolDisplay = 'PROFESOR';
                } else {
                    rolTagClass = '';
                    accesoURL = 'N/A';
                    rolDisplay = 'Desconocido';
                }
                
                // Mostrar solo el usuario, nunca la contraseña hasheada
                fila.insertCell(0).textContent = usuario.usuario;
                fila.insertCell(1).innerHTML = `<span class="tag-rol ${rolTagClass}">${rolDisplay}</span>`;
                fila.insertCell(2).textContent = accesoURL;
                
                const accionesCell = fila.insertCell(3);
                accionesCell.innerHTML = `
                    <button class="action-btn delete-btn" data-id="${usuario.firebaseId}" onclick="eliminarAcceso(this)" title="Eliminar Acceso">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            });
        }
        
        // Manejar el formulario de creación de acceso
        formCrearAcceso.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const usuario = document.getElementById('nombre_usuario').value.trim();
            const passwordPlana = document.getElementById('password').value;
            const rol = document.getElementById('rol_acceso').value;
            
            if (passwordPlana.length < 6) {
                alert("La contraseña debe tener al menos 6 caracteres.");
                return;
            }
            
            // ⚠️ IMPORTANTE: HASHEAR LA CONTRASEÑA ANTES DE ALMACENARLA
            const passwordHasheada = md5(passwordPlana);

            const nuevoUsuario = {
                usuario: usuario,
                password: passwordHasheada, // Almacenamos el hash MD5
                rol: rol,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            const boton = this.querySelector('.boton-rol');
            boton.disabled = true;
            boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';

            usuariosAccesoCollection.add(nuevoUsuario)
                .then(() => {
                    alert(`Acceso para ${usuario} (${rol}) creado exitosamente.`);
                    formCrearAcceso.reset();
                })
                .catch((error) => {
                    console.error("Error al registrar el acceso:", error);
                    alert("Error al registrar: " + error.message);
                })
                .finally(() => {
                    boton.disabled = false;
                    boton.innerHTML = '<i class="fas fa-save"></i> Registrar Credencial';
                });
        });

        // Función para eliminar acceso
        function eliminarAcceso(boton) {
            const docId = boton.getAttribute('data-id');
            if (confirm(`¿Estás seguro de que deseas ELIMINAR PERMANENTEMENTE este acceso? El usuario ya no podrá ingresar.`)) {
                boton.disabled = true;
                usuariosAccesoCollection.doc(docId).delete()
                    .then(() => {
                        // onSnapshot se encargará de recargar la tabla
                    })
                    .catch((error) => {
                        console.error("Error al eliminar el acceso:", error);
                        alert("Error al eliminar: " + error.message);
                        boton.disabled = false;
                    });
            }
        }
    </script>

</body>
</html>
