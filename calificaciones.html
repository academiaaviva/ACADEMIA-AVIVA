<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Calificaciones - Filtrado</title>
    <style>
        /* Paleta: Azul Ultra Oscuro (#00004d), Dorado (#ffc107), Blanco (#ffffff) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding-top: 70px; 
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Navbar --- */
        .navbar {
            background-color: #00004d; color: white; padding: 5px 20px; width: 100%; position: fixed; top: 0; left: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); display: flex; justify-content: space-between; align-items: center;
        }
        .header-contenido { display: flex; align-items: center; }
        .logo-header { height: 50px; margin-right: 15px; }
        .header-contenido h1 { font-size: 24px; font-weight: bold; color: white; margin: 0; }
        
        /* --- Contenido Principal y Tabla --- */
        .main-content {
            margin-top: 30px; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); width: 90%; max-width: 1200px;
        }
        
        h2 { color: #00004d; margin-top: 0; margin-bottom: 20px; }
        
        /* Contenedor de Filtros (Barra de B√∫squeda y Selector) */
        .filters-container {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            align-items: center;
        }

        .filter-group {
            flex-grow: 1;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #00004d;
        }

        .filter-group input, .filter-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }

        /* Tabla */
        #gradesTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        #gradesTable th, #gradesTable td {
            border: 1px solid #ddd;
            padding: 8px 5px;
            text-align: center;
        }
        #gradesTable th {
            background-color: #ffc107; /* Dorado */
            color: #00004d;
        }
    </style>
        <link rel="icon" href="https://i.ibb.co/Qv2NxLbN/fbbf9ca0-b866-4ce4-a827-443177c32603-removebg-preview.png">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

<nav class="navbar">
    <div class="header-contenido">
        <img src="https://i.ibb.co/Qv2NxLbN/fbbf9ca0-b866-4ce4-a827-443177c32603-removebg-preview.png" alt="Logo AVIVA" class="logo-header">
        <h1>Historial de Calificaciones</h1>
    </div>
</nav>

<div class="main-content">
    <h2>Mi Registro Acad√©mico</h2>

    <div class="filters-container">
        <div class="filter-group" style="flex-basis: 70%;">
            <label for="searchBar">Buscar Estudiante o ID:</label>
            <input type="text" id="searchBar" onkeyup="applyFilters()" placeholder="Escribe nombre o ID estudiantil...">
        </div>
        
        <div class="filter-group" style="flex-basis: 30%;">
            <label for="yearSelector">Seleccionar A√±o Acad√©mico:</label>
            <select id="yearSelector" onchange="applyFilters()">
                <option value="TODOS">TODOS</option>
                <option value="2025" selected>2025 (Actual)</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
            </select>
        </div>
    </div>

    <div style="overflow-x: auto;">
        <table id="gradesTable">
            <thead>
                <tr>
                    <th>ID Estudiantil</th>
                    <th>Estudiante</th>
                    <th>Maestro</th>
                    <th>Materia/Categor√≠a</th>
                    <th>N1</th><th>N2</th><th>N3</th><th>N4</th><th>N5</th>
                    <th>N6</th><th>N7</th><th>N8</th><th>N9</th><th>N10</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="14">Cargando calificaciones desde Firebase...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // üîë TU CONFIGURACI√ìN DE FIREBASE üîë
    const firebaseConfig = {
        apiKey: "AIzaSyC1siR7mrHnOTXozBk6lZ22ZxU352ve4lI",
        authDomain: "academia-aviva.firebaseapp.com",
        projectId: "academia-aviva",
        storageBucket: "academia-aviva.firebasestorage.app",
        messagingSenderId: "1083662705160",
        appId: "1:1083662705160:web:31252ae5d15e994823a7bd",
        measurementId: "G-GNBRN8CF2T"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const gradesCollection = db.collection('student_grades'); 
    
    let allGradesData = []; // Almacena todos los datos de Firebase
    
    // OYENTE EN TIEMPO REAL (LECTURA DE DATOS)
    gradesCollection.onSnapshot(snapshot => {
        allGradesData = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            notes: doc.data().notes || Array(10).fill(0),
            // Simulamos el a√±o acad√©mico para que el filtro funcione
            // En un sistema real, este dato vendr√≠a de Firebase
            year: doc.data().year || '2025' 
        }));
        applyFilters(); // Aplicar filtros al cargar o actualizar los datos
    }, error => {
        console.error("Error al escuchar cambios en Firestore:", error);
        document.querySelector('#gradesTable tbody').innerHTML = '<tr><td colspan="14" style="color:red; text-align: center;">Error de conexi√≥n con la base de datos.</td></tr>';
    });

    /**
     * Aplica el filtro de b√∫squeda y el filtro de a√±o a los datos.
     */
    window.applyFilters = function() {
        const searchTerm = document.getElementById('searchBar').value.toLowerCase().trim();
        const selectedYear = document.getElementById('yearSelector').value;

        let filteredGrades = allGradesData.filter(item => {
            // 1. Filtro de B√∫squeda por Nombre o ID
            const matchesSearch = item.studentName.toLowerCase().includes(searchTerm) || 
                                  item.studentId.toLowerCase().includes(searchTerm);

            // 2. Filtro de A√±o Acad√©mico
            const matchesYear = (selectedYear === 'TODOS' || item.year === selectedYear);

            return matchesSearch && matchesYear;
        });

        renderTable(filteredGrades);
    };


    // RENDERIZADO DE LA TABLA (SOLO LECTURA)
    function renderTable(grades) {
        const tbody = document.querySelector('#gradesTable tbody');
        tbody.innerHTML = '';

        if (grades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="14" style="text-align: center;">No se encontraron calificaciones que coincidan con los filtros.</td></tr>';
            return;
        }

        grades.forEach(item => {
            const row = tbody.insertRow();
            
            // Columnas de informaci√≥n
            row.insertCell().textContent = item.studentId;
            row.insertCell().textContent = item.studentName;
            row.insertCell().textContent = item.teacherName;
            row.insertCell().textContent = item.category;

            // Columnas de Notas (Solo Lectura)
            for (let i = 0; i < 10; i++) {
                const noteCell = row.insertCell();
                const noteValue = item.notes[i] !== undefined ? item.notes[i] : 0;
                noteCell.textContent = noteValue;
                
                // Resaltar notas bajas (ej. Rojo si es < 70)
                if (noteValue < 70) {
                    noteCell.style.backgroundColor = '#f8d7da';
                    noteCell.style.color = '#721c24';
                }
            }
        });
    }

</script>

</body>
</html>
